version: "3.8"

services:
  zenox-bot-staging:
    image: ghcr.io/derusbstick/zenox:staging
    environment:
      - ENV=test
    secrets:
      - source: zenox_staging_bot_token
        target: bot_token
      - source: zenox_staging_discord_dev_guild_id
        target: discord_dev_guild_id
      - source: zenox_staging_sentry_dsn
        target: sentry_dsn
      - source: zenox_staging_youtube_api_key
        target: youtube_api_key
      - source: zenox_staging_seeleland_api_url
        target: seeleland_api_url
      - source: zenox_staging_db_url
        target: db_url
      - source: zenox_staging_discord_webhook
        target: discord_webhook
    networks:
      - zenox_staging_net
    deploy:
      replicas: 1
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
      resources:
        limits:
          memory: 3G
        reservations:
          memory: 256M
      placement:
        constraints:
          - node.hostname == Lifty

networks:
  zenox_staging_net:
    driver: overlay

secrets:
  zenox_staging_bot_token:
    external: true
  zenox_staging_discord_dev_guild_id:
    external: true
  zenox_staging_sentry_dsn:
    external: true
  zenox_staging_youtube_api_key:
    external: true
  zenox_staging_seeleland_api_url:
    external: true
  zenox_staging_db_url:
    external: true
  zenox_staging_discord_webhook:
    external: true
